# 클러스터간 데이터 미러링하기
- 복제: 데이터베이스 서버 간에 지속적으로 데이터를 복사하는 행위를 말함
  - 같은 클러스터에 속한 카프카 노드 간의 데이터 교환을 복제라고 부름
- 미러링:
  - 카프카 클러스터간의 데이터 복제를 말함
  - 이러한 데이터 복제를 수행하기 위한 툴이 미러메이커를 포함하고 있음
## 클러스터간 미러링 활용 사례
- 지역 및 중앙 클러스터
- 고가용성과 재해 복구
- 규제
- 클라우드 마이그레이션
- 엣지 클러스터로부터의 데이터 집적

## 다중 클러스터 아키텍쳐
### 데이터 센터간 통신의 현실적 문제들
- 높은 지연
- 제한된 대역폭
- 더 높은 비용
- 카프카 브로커를 서로 다른 데이터센터에 나눠서 설치하는 것은 권장되지 않음
- 프로듀서의 전송 재시도를 늘리거나 전송을 시도하는 사이 레코드를 저장해 두는 버퍼의 크기를 증가시켜 통신 지연에 대응함
- 논의할 아키텍쳐 원칙
  - 하나의 데이터센터당 한 개 이상의 클러스터를 설치함
  - 각각의 데이터센터 간에 각각의 이벤트를 정확히 한 번씩 복제함
  - 가능하다면, 원격 데이터센터에 쓰는 것보다 원격 데이터센터에서 읽어오는 것이 더 괜찮음
### 허브-앤-스포크 아키텍쳐
- 여러 개의 로컬 카프카 클러스터와 한 개의 중앙 카프카 클러스터가 있는 상황을 상정한 것임
- 리더와 팔로워 두 개의 클러스터만 사용하는 단순한 아키텍쳐 방식이 있음
- 데이터가 여러 개의 데이터센터에서 생성되는 반면, 일부 컨슈머는 전체 데이터를 사용해야 할 경우 사용됨
- 항상 로컬 데이터센터에서 데이터가 생성되고, 각각의 데이터센터에 저장된 이벤트가 중앙 데이터센터로 단 한 번만 미러링됨
- 지역 데이터센터에 있는 애플리케이션은 다른 데이터세터에 있는 데이터를 사용할 수 없는 단점도 있음
### 액티브-액티브 아키텍처
- 2개 이상의 데이터센터가 전체 데이터의 일부 혹은 전체를 공유하면서, 각 데이터센터가 모두 읽기와 쓰기를 수행할 수 있어야 할 경우 사용됨
- 인근 데이터센터에서 사용자들의 요청을 처리할 수 있음
- 데이터 중복과 회복 탄력성
  - 한 데이터센터에 장애가 발생하더라도, 사용자 요청을 다른 데이터센터에서 처리할 수 있음
  - 이러한 종류의 장애 복구는 네트워크 리다이렉션만을 필요로 하며, 보통 가장 쉽고 명료한 형태의 장애 복구임
- 여러 위치에서 비동기적으로 읽거나 변경할 경우 발생하는 충돌을 피하는 것이 어려움
- 액티브-액티브 미러링 수행할때 데이터센터 개수가 2개 이상일 경우, 각 쌍의 데이터센터의 양 방향에 대해 미러링 작업이 필요할 것이라는 거..
- 같은 데이터가 클러스터 사이에서 계속해서 순환 미러링 되는 것을 막아야함
### 액티브-스탠바이 아키텍쳐
- 다중 클러스터에 대한 유일한 요구 조건이 특정한 상황의 재해 대비일 수 있음
- 비상시 두 번째 클러스터를 사용해서 작동함
- 두 번째 클러스터를 설치한 뒤, 첫 번째 클러스터읨 모든 이벤트를 미러링하는 프로세스를 설치하면 됨
- 멀쩡한 클러스터를 늘려야 한다는 단점이 있음

### 장애 복구
1. 재해 복구 계획하기
2. 계획에 없던 장애 복구에서의 데이터 유실과 불일치
   - DR 클러스터는 항상 최신 메시지를 가지지 못하기에, 모니터링해줘야함
3. 장애 복구 이후 애플리케이션의 시작 오프셋
  - 자동 오프셋 재설정
  - 오프셋 토픽 복제
  - 시간 기반 장애 복구
  - 오프셋 변환
4. 장애 복구가 끝난 후
  - 장애가 생겼던 주 클러스터를 이제 DR클러스터로 역할을 변경해야 함
  - 주 클러스터에 저장된 데이터와 커밋된 오프셋을 완전히 삭제한 뒤, 새로운 주 클러스터에서 완전히 새것이 된 새 DR 클러스터로 미러링을 시작하는 것임
5. 클러스터 디스커버리 관련
  - 장애가 발생한 상황에서 애플리케이션이 장애 복구용 클러스터와 통신을 시작하는 방법을 알 수 있게 하는 것임
### 스트레치 클러스터
- 데이터센터 전체에 문제가 발생했을 때 카프카 클러스터에 장애가 발생하는 것을 방지하기 위한 것임
- 하나의 카프카 클러스터를 여러 개의 데이터센터에 걸쳐 설치하는 것임
  - 다중 클러스터가 아니고, 하나의 클러스터임
  - 두 클러스터를 동기화시켜주는 미러링 프로세스가 필요 없음
- 동기적인 복제임
- 양 데이터센터와 클러스터 안의 모든 브로커가 사용된다는 장점을 가짐
- 대응할 수 있는 장애의 종류가 한정되어 있는 단점이 있음
- 이 아키텍쳐는 카프카를 높은 대역폭과 낮은 지연을 가진 회선으로 서로 연결된 최소 3개의 데이터센터에 설치할 수 있을때 적당함
  - 3개인 이유는 주키퍼 클러스터 때문..
  - 주키퍼 클러스터는 홀수 개의 노드로 이루어지며, 노드 주에서 과반 이상만 작동한다면 전체 클러스터 역시 이상이 없음
  - 2개의 데이터센터에 홀수 개의 주키퍼 노드를 배치하면, 하나의 데이터센터에는 과반 이상의 노드가 배칠되고, 센터에 문제가 생기면 주키퍼와 카프카에 연쇄적인 장애가 발생함
### 아파치 카프카 미러메이커
- 두 데이터센터 간의 데이터 미러링을 위해 미러메이커라는 툴을 포함함
- 아파치 카프카를위한 차세대 다중 클러스터 미러링 솔루션임
  - 재해 복구, 백업, 마이그레이션, 데이터 집적 등 넓은 범위의 활용 사례를 지원할 수 있도록 복잡한 토폴로지를 쉽게 설정할 수 있음
  - 미러메이커는 데이터베이스가 아닌, 다른 카프카 클러스터로부터 데이터를 읽어 오기 위해 소스 커넥터를 사용함
  - 미러메이커는 카프카의 컨슈머 그룹 관리 프로토콜을 사용하지 않고, 태스크에 파티션을 균등하게 배분함
    - 새로운 토픽이나 파티션이 추가될때, 리밸런스로 인해 지연이 튀어오르는 상황을 방지함
  - 미러메이커는 원본 클러스터의 각 파티션에 저장된 이벤트를 대상 클러스터의 동일한 파티션으로 미러링함
    - 의미 구조나 이벤트 순서를 그대로 유지함
  - 데이터 복제뿐만 아니라 컨슈머, 오프셋, 토픽 설정 토픽 ACL 마이그레이션까지 지원함
### 미러메이커 설정하기
p.277~p.279

### 다중 클러스터 토폴로지
### 미러메이커 보안
- 미러메이커의 경우 원본과 대상 클러스터 양쪽에 대해 보안이 적용된 브로커 리스너를 사용하도록 설정되야 함
- 클라이언트 쪽에 대해서도 보안이 설정되야 함
- 모든 데이터센터간 트래픽에는 SSL 암호화가 적용되야함
### 프로덕션 환경에 미러메이커 배포하기
p.281~p.286 - 정리보다 흐름 읽어 보는게 좋은거 같음
- 카프카 커넥트 모니터링
- 미러메이커 지표 모니터링
- 랙 모니터링
- 프로듀서/컨슈머 지표 모니터링
- 카나리아 테스트
### 미러메이커 튜닝하기
p.286~p.288
## 기타 클러스터간 미러링 솔루션
### 우버 uReplicator
  - 우버에서는 미러링을 수행할  때 정규식 필터를 사용하는 대신 정확한 토픽 이름 목록을 유지하는 방법을 택함
    - 리밸런스가 무한 반복되는 문제가 발생할 수 있음
    - 문제를 해결하기 위해 자체 uReplicator를 개발함
    - 인스턴스에 할당된 토픽 목록과 파티션들을 관리하는 중앙집중화된 컨트롤러를 구현함
### 링크드인 브루클린
- 우버와 마찬가지로 카프카 클러스터간 데이터 전송을 위해 레거시 미러메이커를 사용함
- 자체적인 데이터 스트리밍 시스템 위에 미러링 솔루션을 구축함
- 서로 다른 종류의 데이터 저장소 사이에 데이터 스트리밍해 줄 수 있는 분산 서비스
### 컨플루언트의 데이터센터간 미러링 솔루션
  - 컨플루언트 리플리케이터
  - 멀티 리전 클러스터
  - 클러스터 링킹

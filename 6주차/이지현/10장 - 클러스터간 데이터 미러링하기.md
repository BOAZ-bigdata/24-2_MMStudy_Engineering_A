# 10장 클러스터간 데이터 미러링하기
상호 의존하는 클러스터 사이에 데이터를 지속적으로 복사해줘야하는 경우, 카프카 클러스터 간의 데이터 복제를 `미러링`이라고 부른다.
아파치 카프카에는 클러스터간 데이터 복제를 수행하기 위한 툴로 `미러메이커`를 포함하고 있다. 

### 클러스터가 미러링 활용 사례
- 지역 및 중앙 클러스터
- 고가용성과 재해 복구
- 규제
- 클라우드 마이그레이션
- 엣지 클러스터로부터의 데이터 집적

## 다중 클러스터 아키텍처
데이터 센터 간 통신에서 현실적으로 고려해야 할 사항들을 볼텐데 이때 특정한 네트워크 환경에서의 트레이드오프를 반영한다는 것을 이해하는 것이 좋다!

앞으로 논의할 아키텍처에 해당하는 원칙
- 하나의 데이터센터당 한 개 이상의 클러스터를 설치한다
- 각각의 데이터센터 간에 각각의 이벤트를 정확히 한 번씩 복제한다
- 가능하다면, 원격 데이터센터에 쓰는 것보다 원격 데이터센터에서 읽어오는 것이 더 낫다

### 허브-앤-스포크 아키텍처
여러 개의 로컬 카프카 클러스터와 한 개의 중앙 카프카 클러스터가 있는 상황을 상정한 것

- 데이터가 여러 개의 데이터센터에서 생성되고, 일부 컨슈머는 전체 데이터를 사용해야 할 경우 사용됨
- 로컬 데이터센터에서 데이터가 생성되고, 각각의 데이터센터에 저장된 이벤트가 중앙 데이터센터로 단 한 번만 미러링된다는 점.

- 하지만 지역 데이터센터에 있는 애플리케이션은 다른 데이터센터에 있는 데이터를 사용할 수 없다.(중앙으로만 연결되니까)

### 액티브-액티브 아키텍처
2개 이상의 데이터센터가 전체 데이터의 일부 혹은 전체를 공유하면서 각 데이터센터가 모두 읽기와 쓰기를 수행할 수 있는 경우

- 은근 데이터센터에서 사용자들의 요청을 처리할 수 있다
- 데이터를 여러 위치에서 비동기적으로 읽거나 변경할 경우 발생하는 충돌을 피하기 어려움
- 각 쌍의 데이터센터의 양 방향에 대해 미러링 작업이 필요
- 같은 데이터가 클러스터 사이를 오가면서 끝없이 순환 미러링되는 것을 막아야 함

- 글로벌 서비스 제공이나 서비스 중단이 용납될 수 없는 환경에서 매우 효과적이라고 함. 
### 액티브-스탠바이 아키텍처
재해 대비를 위해서 구현하는. 하나의 데이터센터 안에 두 개의 클러스터를 가지고 있다고 하면 첫 번째 클러스터의 거의 모든 데이터를 가지고 있다가 이게 망가지면 두 번째 클러스터가 필요할 수 있음

두 번째 클러스터를 설치한 뒤에 첫 번째 클러스터의 모든 이벤트를 미러링하는 프로세스를 설치하면 됨.

DR(diaster recovery) 클러스터로 장애 복구를 어떻게 하는 걸까?
1. 복구 시간 목표를 설정해야하고
2. DR 클러스터가 주 클러스터에서 얼마나 뒤처져 있는지 항상 모니터링해야 하지만, 뒤처져 있더라도 예쌍치 못한 장애 복구는 어느 정도의 유실을 감수해야한다.
3. 다른 클러스터로 옮겨간 애플리케이션이 데이터를 읽어오기 시작해야하는 위치(=시작 오프셋)을 정해야한다.
- 자동 오프셋 재설정
    - 아파치 카프카 컨슈머는 사전에 커밋된 오프셋이 없을 경우 파티션의 맨 앞에서부터 읽을지 맨 뒤에서부터 읽을지 결정하는 오프셋을 가진다.
- 오프셋 토픽 복제
    - 컨슈머가 자신의 오프셋을 특별한 토픽에 커밋하고 이 토픽을 DR 클러스터로 미러링해줘서 여기서 읽기 작업을 시작하는 컨슈머가 이전에 주 클러스터에 마지막으로 커밋한 오프셋부터 작업을 재개
- 시간 기반 장애 복구
    - 애플리케이션에 시작 시간을 지정할 수 있는 사용자의 설명 넣는 방법
- 오프셋 변환
    - 오프셋 매핑은 클러스터 간의 오프셋 값 차이가 달라질 때 저장되는데 주 클러스터 오프셋에 매핑되는 DR 클러스터 오프셋을 찾아서 여기부터 작업하게 하는 방법
4. 장애 복구 후 주 클러스터를 다시 DR 클러스터로 역할을 변경해주기

### 스트레치 클러스터
다중 클러스터가 아닌, 하나의 클러스터로 두 클러스터를 동기화시켜주는 미러링 프로세스가 필요 없다.

- 동기적인 복제: DR 클러스터가 주 클러스터와 언제나 100% 동기화되어 있어야만 하는 경우도 있다.
- 대응 가능한 장애 종류가 한정되어 있다

## 아파치 카프카의 미러메이커
미러메이커는 두 데이터센터 간의 데이터 미러링을 위해 사용되는 툴로 현재는 재해복구, 백업, 마이그레이션, 데이터 집적 등 넓은 범위의 활용 사례를 지원할 수 있도록 복잡한 토폴리지(네트워크의 요소들을 물리적으로 연결해놓은 것)를 쉽게 설정할 수 있다.

미러메이커에서는 각각의 태스크가 한 쌍의 컨슈머와 프로듀서로 이뤄진다.

### 액티브-스탠바이 복제 흐름을 정의하기 위한 미러메이커 설정 예제
- 복제 흐름 설정
- 미러링 토픽
-  컨슈머 오프셋 마이그레이션
- 토픽 설정 및 ACL 마이그레이션
- 커넥터 태스크

- 설정 접두어

### 미러메이커 배포

미러 메이커는 카프카 커넥트에서 미러메이커를 실행시킬 수도 있고, 별도로 설치된 분산 모드 카프카 커넥트 클러스터에서 커넥터 형태로 실행될 수도 있다.

지역 읽기 - 원격 쓰기를 해야할 경우
- 데이터 간에 전송될 때는 암호화를 해야하지만, 데이터센터 안에서는 암호화할 필요가 없는 데이터
- 하이브리드 환경
    - 온프레미스 클러스터의 토픽을 클라우드 클러스터로 미러링 하는 것

# 10장 클러스터간 데이터 미러링 하기

태그: 카프카 핵심 가이드
주차: 5

- 2개 이상의 클러스터가 서로 완전히 분리되어 있는 경우
    - 다른 용도
    - → 한쪽에 있는 데이터를 다른 쪽으로 복사할 이유 X
- 하지만, 운영자가 상호 의존하는 클러스터 사이에 데이터를 지속적으로 복사해줘야 하는 경우 존재
    - 데이터베이스에서, 데이터베이스 서버 간에 지속적으로 데이터 복사하는 행위 = 복제 replication
    - 카프카 클러스터 간의 데이터 복제 = 미러링 mirroring
        - cf. 같은 클러스터에 속한 카프카 노드 간의 데이터 교환 = 복제
    - 카프카에는 클러스터간 데이터 복제를 수행하기 위한 툴: 미러메이커 포함

## 1. 클러스터간 미러링 활용 사례

- 지역 및 중앙 클러스터
- 고가용성과 재해 복구
- 규제
- 클라우드 마이그레이션
- 엣지 클러스터로부터의 데이터 집적

## 2. 다중 클러스터 아키텍처

- 데이터 센터 간 통신에서 현실적으로 고려해야 할 사항들
- 공통적인 아키텍처 패턴

### 데이터센터 간 통신의 현실적인 문제들

- 데이터센터간 통신 시 고려해야 할 사항
    - 높은 지연
    - 제한된 대역폭
    - 더 높은 비용
- 기본적으로
    - 카프카의 브로커와 클라이언트는 하나의 데이터 센터 안에서 실행되도록 설계, 개발, 테스트 되었음
    - → 각종 값들이 이 상황에 맞춰 설정되어 있음
    - → 서로 다른 데이터 센터에 나눠서 설치하는 것 권장 X
- 원격 브로커-컨슈머 통신
    - 가장 안전한 형식의 클러스터 간 통신 (데이터 유실 위험성 X)
- 논의할 아키텍처 대부분이 해당하는 원칙
    - 하나의 데이터센터당 한 개 이상의 클러스터를 설치한다
    - 각각의 데이터 센터 간에 각각의 이벤트를 정확히 한 번씩 복제
    - 가능하다면 원격 데이터센터에 쓰는 것보다 원격 데이터센터에서 읽어오는 것이 낫다

### 허브-앤-스포크 아키텍처

- 여러 개의 로컬 카프카 클러스터와 한 개의 중앙 카프카 클러스터가 있는 상황을 상정한 것
    - 단순화된 형태: 리더와 팔로워 클러스터 형태
- 데이터가 여러 개의 데이터센터에서 생성되는 반면, 일부 컨슈머는 전체 데이터를 사용해야 할 경우
- 장점:
    - 항상 로컬 데이터센터에서 데이터가 생성
    - 각각의 데이터센터에 저장된 이벤트가 중앙 데이터 센터로 단 한번만 미러링된다는 점
    - 한 방향으로 미러링 진행
    - 컨슈머는 항상 같은 클러스터에서 데이터 읽음
    - → 배포, 설정, 모니터링 간편
- 단점:
    - 지역 데이터 센터에 있는 애플리케이션은 다른 데이터센터에 있는 데이터 사용 불가
- 중앙 데이터센터에 각 지역 데이터센터별로 미러링 프로세스를 최소 한 개 이상 설정
    - 원격 지역 클러스터의 데이터를 읽어서 중앙 클러스터에 씀
    - 같은 이름의 토픽 존재
        - 중앙 클러스터의 같은 이름 토픽
        - 각각의 데이터센터에서 미러링된 이벤트를 서로 다른 토픽에 씀

### 액티브-액티브 아키텍처

- 2개 이상의 데이터센터가 전체 데이터의 일부 혹은 전체를 공유, 각 데이터센터가 모두 읽기와 쓰기를 수행
- 장점:
    - 인근 데이터센터에서 사용자들의 ㅇ요청 처리 가능
    - 데이터 중복과 회복 탄력성
- 단점:
    - 데이터를 여러 위치에서 비동기적으로 읽거나 변경할 경우, 발생하는 충돌 불가피
- 같은 데이터가 클러스터 사이를 오가면서 끝없이 순환 미러링 되는 것 방지 필요
    - 미러메이커와 같은 미러링 툴은 네이밍 컨벤션을 사용 → 순환 미러링 방지
    - 레코드 헤더 기능: 각각의 이벤트에 데이터가 생성된 데이터 센터를 태그할 수 있도록 함 → 순환 미러링 방지

### 액티브-스탠바이 아키텍처

- 다중 클러스터에 대한 유일한 요구 조건이 특정한 상황의 재해 대비뿐일 수 있음
    - 프로덕션 환경 카프카 클러스터, 장애 복구용 카프카 클러스터(DR disaster recovery)
- 장점:
    - 간단한 설치: 두 번째 클러스터 설치 후, 첫 번째 클러스터의 모든 이벤트를 미러링하는 프로세스 설치만 하면 됨
    - 데이터 접근, 충돌 처리, 기타 복잡한 아키텍처 문제 신경 X
- 단점:
    - 멀쩡한 클러스터를 놀려야 함
    - 카프카 클러스터 간의 장애 복구가 보기보다 훨씬 어려운 일
- 장애 복구에 필요한 것들
    - 재해 복구 계획하기
        - 복구 시간 목표, 복구 지점 목표
    - 계획에 없던 장애 복구에서 데이터 유실과 불일치
    - 장애 복구 이후 애플리케이션의 시작 오프셋
        - 자동 오프셋 재설정, 오프셋 토픽 복제, 시간 기반 장애 복구, 오프셋 변환
    - 장애 복구가 끝난 후
        - 장애가 생겼던 주 클러스터를 DR 클러스터 역할로 변경
    - 클러스터 디스커버리 관련
        - DNS 사용 (모든 브로커에 대한 IP 주소x, 대체로 3개)

### 스트레치 클러스터

- 데이터센터 전체에 문제가 발생했을 때, 카프카 클러스터에 장애가 발생하는 것을 방지하기 위한 것
    - 하나의 카프카 클러스터를 여러 개의 데이터 센터에 걸쳐 설치
    - ≠ 다중 클러스터 → 미러링 프로세스 X

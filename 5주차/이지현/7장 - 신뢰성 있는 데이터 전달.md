# 7장 신뢰성 있는 데이터 전달
카프카는 신뢰성 있는 데이터 전달에 있어서 매우 유연하다. 

세세한 지점까지 설정이 가능해서, 최고의 신뢰성을 필요로 하는 것 부터 처리속도나 단순성을 우선시하는 거까지 모두 설정 가능하다

## 신뢰성 보장
보장이란 서로 다른 상황에서도 시스템이 지킬 것이라 보장되는 행동을 의미

신뢰성 있는 애플리케이션을 개발하고자 한다면 카프카가 제공하는 보장을 이해하는 것은 필수적이다.

아파치 카프카는 무엇을 보장할까?
- 카프카는 파티션 안의 메시지들 간에 순서를 보장
- 클라이언트가 쓴 메시지는 모든 인-싱크 레플리카의 파티션에 쓰여진 뒤에야 커밋 된 것으로 간주
- 커밋된 메시지들을 최소 1개의 작동 가능한 레플리카가 남아 있는 한 유실되지 않는다.
- 컨슈머는 커밋된 메시지만 읽을 수 있다.

신뢰성 있는 시스템을 구축하는 데는 트레이드오프가 있는 법이고, 카프카는 이러한 트레이드오프들을 조절할 수 도록 설정 매개변수를 조절함으로써 어느 정도의 신뢰성이 필요한지를 결정할 수 있게 개발되었다.

## 복제
카프카의 복제 메커니즘은 파티션별로 다수의 레플리카를 유지한다는 특성과 함께 카프카의 신뢰성 보장의 핵심이라고 할 수 있다.

카프카 토픽은 파티션으로 이루어져있고 하나의 파티션은 하나의 디스크에 저장된다. 카프카는 파티션에 저장된 이벤트들의 순서를 보장하며 파티션은 온라인 상태거나 오프라인 상태일 수 있다.

각 파티션은 다수의 레플리카를 가질 수 있고 그 중 하나가 리더가 된다. 나머지는 팔로워 레플리카, 이것들은 최신 이벤트를 제 시간에 복사해오기만 하면 된다. 

만약 리더가 작동 불능 상태가 되면, 인-싱크 레플리카 중 하나가 새 리더가 된다.

인-싱크 상태인 레플리카
- 주키퍼와의 활동 세션이 있다.
- 최근 10초 사이 리더로부터 메시지를 읽어 왔다
- 최근 10초 사이에 리더로부터 읽어 온 메시지들이 가장 최근 메시지이다. 

## 브로커 설정
메시지 저장 신뢰성 관련된 카프카의 작동을 변경시키는 브로커의 설정 매개변수는 3개 있다. 많은 설정 변수들과 마찬가지로 브로커 단위에서 적용되어 시스템 안의 모든 토픽들을 제어할 수도 있고 특정 토픽의 작동을 제어할 수 있다.

## 신뢰성 있는 시스템에서 프로듀서 사용하기
사용 가능한 가장 높은 신뢰성 설정을 브로커에 적용하더라도, 프로듀서 역시 신뢰성이 있도록 설정해주어야 시스템 전체에서의 데이터 유실을 방지 할 수 있다

### 응답 보내기
프로듀서는 3가지 응답 모드 중 하나를 선택할 수 있다.

1. acks = 0

프로듀서가 네트워크로 메시지를 전송한 시점에서 메시지가 카프카에 성공적으로 쓰여진 것으로 간주됨.

2. acks = 1

리더가 메시지를 받아서 파티션 데이터 파일에 쓴 직후 응답 또는 에러를 보낸다는 것을 의미

3. acks = all

리더가 모든 인-싱크 레플리카가 메시지를 받아갈 때까지 기다렸다가 응답하거나 에러를 보낸다는 것을 의미.

메시지가 유실되지 않는 것이 목표일 경우, 가장 좋은 방법은 재시도 가능한 에러가 발생했을 경우 프로듀서가 계속해서 메시지 전송을 재시도하도록 설정하는 것

## 신뢰성 있는 시스템에서 컨슈머 사용하기

카프카의 신뢰성 보장을 고려하여 데이터를 쓰는 방법 + 읽는 방법에 대해

컨슈머는 커밋된 데이터만 읽을 수 있다. 즉, 모든 인-싱크 레플리카에 쓰여진 다음부터 읽을 수 있다. 

파티션으로부터 데이터를 읽어올 때, 컨슈머는 메시지를 배치 단위로 읽어온 뒤 배치별로 마지막 오프셋을 확인한 뒤, 브로커로부터 받은 마지막 오프셋 값에서 시작하는 다른 메시지 배치를 요청함으로써 카프카 컨슈머는 메시지 누락 없이, 언제나 새로운 데이터를 올바른 순서로 읽어옴

## 시스템 신뢰성 검증하기
설정 검증, 애플리케이션 검증, 프로덕션 환경에 배포된 애플리케이션 모니터링




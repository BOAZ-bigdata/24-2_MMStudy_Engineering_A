# 8장 '정확히 한 번' 의미 구조
카프카의 정확히 한 번 의미 구조는 **멱등적 프로듀서와 트랜잭션**의 조합으로 이루어진다.

## 8.1 멱등적 프로듀서

### 8.1.1 멱등적 프로듀서의 작동 원리
해당 기능을 켜게 되면 모든 메시지는 고유한 프로듀서 ID와 시퀀스 넘버를 갖게 된다.

이 두가지를 이용해 브로커가 이전에 받은 적이 있는 메시지를 받게 될 경우, 적절한 에러를 발생시킨다.

멱등적 프로듀서는 프도류서 자체의 재시도 매커니즘에 의한 중복만을 방지할 뿐, 그 이상은 하지 않는다.

즉, 외부적인 요인에 의해 중복 메시지가 두번 send() 되는 상황에서는 이를 방지할 방법이 없다.

### 8.1.3 멱등적 프로듀서 사용법
멱등적 프로듀서를 동잓시키기 위해서는 `enable.idempotence=true`를 추가해주면 된다.
- 프로듀서 ID를 받아오기 위해 프로듀서 시동 과정에서 API를 하나 더 호출한다.
- 전송되는 각각의 레코드 배치에는 프로듀서 ID와 배치 내 첫 메시지의 시퀀스 넘버가 포함된다.
- 브로커들은 모든 프로듀서 인스턴스에서 들어온 레코드 배치의 시퀀스 넘버를 검증해서 메시지 중복을 방지한다.
- 장애가 발생하더라도 각 파티션에 쓰여지는 메시지들의 순서는 보장된다.

다음과 같은 변경사항이 발생한다.

## 8.2 트랜잭션

### 8.2.3 트랜잭션은 어떻게 정확히 한 번을 보장하는가?
트랜잭션을 통해 행위를 보장하여 정확히 한 번 수행할 수 있도록 한다.

구체적으로,

트랜잭션적 프로듀서를 사용하기 위해서는 `transactional.id`값을 넣어주고 `initTransactions()`를 호출하여 초기화 해주기만 하면 된다. 이 때 transactional.id에 해당하는 에포크 값이 증가하며, 이를 이용해 좀비 인스턴스가 출력에 영향을 주는 것을 방지한다.

컨슈머에서도 트랜잭션 기능을 쓸 수 있다.
`isolation.level` 값을 `read_committed`로 잡을 경우 커밋된 트랜잭션에 속한 메시지나 처음부터 트랜잭션에 속하지 않는 메시지만 리턴된다.

`read_uncommitted`의 경우 모든 메시지 레코드들을 리턴한다.

https://westlife0615.tistory.com/673

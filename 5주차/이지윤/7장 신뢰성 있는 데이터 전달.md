# 7장 신뢰성 있는 데이터 전달

태그: 카프카 핵심 가이드
주차: 4

## 1. 신뢰성 보장

- 보장: 서로 다른 상황에서도 시스템이 지킬 것이라는 보장되는 행동
- 표준 신뢰성 보장 ACID: 관계형 데이터베이스가 보편적으로 지원
    - 원자성 Atomicity, 일관성 Consistency, 격리성 Isolation, 지속성 Durability
- 아파치 카프카 보장
    - 파티션 안의 메세지들 간에 순서 보장
    - 클라이언트가 쓴 메세지는 모든 인-싱크 레플리카의 파티션에 쓰여진 뒤에야 “커밋”된 것으로 간주
    - 커밋된 메세지들은 최소 1개의 작동 가능한 레플리카가 남아 있다 (유실X)
    - 컨슈머는 커밋된 메세지만 읽기 가능

## 2. 복제

- 카프카의 복제 매커니즘은 파티션별로 다수의 레플리카를 유지한다는 특성과 함께 카프카의 신뢰성 보장의 핵심

## 3. 브로커 설정

- 메세지 저장 신뢰성 관련된 브로커 설정 매개변수는 세 개

### 복제 팩터

- 이 책에서는 지금까지 토픽의 복제 팩터가 3이라고 가정
    - = 각 브로커가 3대의 서로 다른 브로커에 3개 복제됨
- 복제 팩터가 클수록 가용성, 신뢰성 증가, 장애 발생 가능성 감소
- 복제 팩터 증가 = 디스크 공간 증가
- → 가용성과 하드웨어 사용량 사이에 트레이드오프
- 고려사항
    - 가용성
    - 지속성
    - 처리량
    - 종단 지연
    - 비용
    - 위치

### 언클린 리더 선출

- 이 설정은 브로커 단위(클러스터 단위)에서만 가능
- 파티션 리더가 더 이상 사용 가능하지 않은 경우, 인-싱크 레플리카 중 하나가 새 리더
    - 만약 리더 외에 인-싱크 레플리카가 없다면
    - → 아웃-오브-싱크 레플리카가 새 리더 또는 복구 될 때까지 파티션 오프라인 상태
- 아웃-오브-싱크 레플리카가 리더가 될 수 있도록 허용 시
    - 데이터 유실과 일관성 깨짐의 위험성
    - 기본 값은 리더가 될 수 없도록 되어 있음
    - 사용하더라도 클러스터가 복구된 뒤에는 설정 값을 false로 되돌리기

### 최소 인-싱크 레플리카

- 토픽과 브로커 단위 모두 설정 가능
- 인-싱크 레플리카의 최소 값 설정

### 레플리카를 인-싱크 상태로 유지하기

- 레플리카가 아웃-오브-싱크 상태가 될 수 있는 두 가지 이유 방지하기
    - 주키퍼와의 연결 끊어지거나
    - 리더 업데이트 내역 따라가는 데 실패해서 복제 랙 발생
    - → 두 조건에 대한 카프카 클러스터 민감도 조절하는 브로커 설정
- 카프카 브로커가 주키퍼로 하트비트 전송을 멈출 수 있는 최대 시간 정의
- 레클리카가 리더로부터 데이터를 읽어오지 못하거나 동기화가 풀린 상태 지난 시간 값

### 디스크에 저장하기

- 카프카는 메세지를 받은 레플리카의 수에만 의존, 디스크에 저장되지 않은 메세지에 대해서도 응답
- 세그먼트를 교체할 때와 재시작 직전에만 메세지를 디시크로 플러시, 그 외에는 리눅스의 페이지 캐시 기능에 의존
- (리더의 디스크에 메세지를 쓰는 것보다 더 안전하다는 판단)
- → 더 자주 메세지 저장하도록 설정 가능

## 4. 신뢰성 있는 시스템에서 프로듀서 사용하기

- 브로커 설정 신뢰성 설정 올려도, 프로듀서 역시 설정해야 함
- 카프카에 메세지를 쓰는 애플리케이션 개발자가 신경써야할 것
    - 신뢰성 요구 조건에 맞는 올바른 acks 설정 사용
    - 설정과 코드 모두에서 에러를 올바르게 처리

### 응답 보내기

- 세 가지 응답acknowledgement 모드 중 하나 선택
- acks=0
    - 프로듀서가 네트워크로 메세지 전송 시점에서 메세지가 카프카에 성공적으로 쓰여진 것으로 간주
    - 지연은 낮지만, 종단 지연 개선 X
- acks=1
    - 리더가 메세지를 받아서 파티션 데이터 파일에 쓴 직후 응답 또는 에러 보내는 것 의미
    - 메세지 복제하는 속도보다 더 빨리 리더에 쓸 수 있기 때문에 불완전 복제 파티션 발생 가능
- acks=all
    - 리더가 모든 인-싱크 레플리카가 메세지를 받아갈 때까지 기다렸다가 에러를 보낸다는 것 의미
    - 가장 안전한 옵션이나, 프로듀서 지연이 가장 길어지는 옵션

### 프로듀서 재시도 설정하기

- 에러 처리 → 프로듀서 자동 처리하는 에러, 개발자들이 처리하는 에러
- 프로듀서는 재시도 가능한 에러 처리 가능
    - 에러 코드 두 분류: 재시도하면 해결될 수 있는 것과 아닌 것
    - 메세지가 유실되지 않는 것이 목표 → 재시도 가능한 에러가 발생 시, 프로듀서가 계속해서 메세지 전송 재시도하도록 설정
- 전송 실패한 메세지 재시도하는 것은 두 메세지가 모두 브로커에 성공적으로 쓰여지는, 결과적으로 메세지 중복될 위험 내포
    - 재시도와 주의 깊은 에러 처리는 각 메세지가 “최소 한 번” 저장되도록 보장 가능
    - “정확히 한 번” 보장 불가
    - 추가 매개변수 설정 → 중복 메세지 건너뛰기 가능

### 추가적인 에러 처리

- 재시도 기능 외의 다른 종류의 에러
    - 메세지 크기 관련, 인가 관련 에러 등의 재시도 불가능한 브로커 에러
    - 메세지가 브로커에 전송되기 전에 발생한 에러
    - 재전송 시도 소진, 가용 메모리 메세지 이미 가득차서 발생하는 에러
    - 타임 아웃

## 5. 신뢰성 있는 시스템에서 컨슈머 사용하기

- 컨슈머는 일관성이 보장되는 데이터만 읽음
    - 어느 메세지까지 읽었고 어디까지는 읽지 않았는지 추적 (메세지 읽는 도중의 누락 방지)
    - 파티션으로부터 데이터 읽어올 때, 컨슈머는 매세지를 배치 단위로 읽어온 뒤 배치별 마지막 오프셋 확인
    - → 브로커부터 받은 마지막 오프셋 값에서 시작하는 다른 메세지 배치 요청
- 특정 카프카 컨슈머 작동 정지 시 → 어디서부터 작업 재개? 마지막 읽은 오프셋?

### 신뢰성 있는 처리를 위해 중요한 컨슈머 설정

- 신뢰성을 갖는 컨슈머를 설정하기 위해 알아두어야 하는 컨슈머 속성
    - group.id
    - auto.offset.reset
    - enable.auto.commit
    - auto.commit.interval.ms

### 컨슈머에서 명시적으로 오프셋 커밋하기

- 더 세밀한 제어 필요 시 오프셋 커밋 직접 수행 → 정확성과 성능에 영향
- 데이터 신뢰성 있게 다루는 컨슈머 개발 시 고려해야 할 사항
    - 메세지 처리 먼저, 오프셋 커밋은 나중에
    - 커밋 빈도는 성능, 크래시 발생 시 중복 개수 사이의 트레이드오프
    - 정확한 시점에 정확한 오프셋 커밋
    - 리밸런스
    - 컨슈머는 재시도 해야 할 수 있다
    - 컨슈머가 상태를 유지해야 할 수도 있다

## 6. 시스템 신뢰성 검증하기

- 몇 가지 검증 작업한 뒤 세 개의 계층에 걸쳐 검증 수행 제안

### 설정 검증하기

- 애플리케이션 로직과 격리된 채 브로커와 클라이언트 설정 검증은 쉬움
- 권장하는 이유
    - 요구 조건 충족 가능한지 확인하는 데 도움
    - 시스템의 예상 작동 추론해 보기 위한 좋은 방법
- 테스트 항목
    - 리더 선출
    - 컨트롤러 선출
    - 롤링 재시작
    - 언클린 리더 선출 테스트

### 애플리케이션 검증하기

- 애플리케이션 로직이 카프카의 클라이언트 라이브러리와 상호작용하는 커스텀 에러 처리 코드, 오프셋 커밋, 리밸런스 리스너와 같은 곳 확인
- 애플리케이션 통합 테스트 수행 권장, 다양한 장애 상황에 대해 테스트 수행 권장

### 프로덕션 환경에서 신뢰성 모니터링하기

- 데이터가 예상한 대로 흐르고 있는지 프로덕션 시스템을 지속적으로 모니터링 하는 것은 중요
- 카프카의 자바 클라이언트 쪽 상태, 이벤트 모니터링 지표: JMX 지표
    - 프로듀서의 경우, 신뢰성 측면에서 가장 중요한 두 지표: 레코드별 에러율, 재시도율
    - 컨슈머의 경우, 컨슈머 랙 consumer lag
        - 컨슈머가 브로커 내 파티션에 커밋된 가장 최신 메세지에서 얼마나 뒤떨어져 있는지
        - 
- 데이터의 흐름 모니터링 = 쓰여진 데이터가 적절한 시기에 읽혀진다는 것
- 카프카 브로커는 브로커가 클라이언트로 보내는 에러 응답률을 보여주는 지표들을 포함

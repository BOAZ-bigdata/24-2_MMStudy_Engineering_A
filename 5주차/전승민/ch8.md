# '정확히 한번' 의미 구조
- 애플리케이션들이 메시지를 읽을 때 중복 메시지를 제거할 수 있도록 메시지에 고유한 식별자를 포함함
- 중복 문제와 같은 것을 막기 위해 강력한 보장을 제공해야함 ('정확히 한 번' 의미 구조가 필요함)
- '정확히 한번'의미 구조는 두개의 핵심 기능과 트랜잭션의 조합으로 이루어짐
- 멱등적 프로듀서는 프로듀셔 재시도로 인해 발생하는 중복을 방지함
- 트랜잭션 의미 구조는 스트림 처리 애플리케이션에서 '정확히 한 번' 처리를 보장함
## 멱등적 프로듀서
- 동일한 작업을 여러 번 실행해도 한 번 실행한 것과 결과가 같은 서비스를 '멱등적'이라고 함
- 만약 카프카 프로듀서가 멱등성 의미 구조가 아닌 최소 한 번 의미 구족를 가지면,
- 프로듀서가 메시지 전송을 재시도함으로써 메시가 최소 한 번 이상 도착하는 불확실성이 존재함 (메시지 중복이 발생함)
- ex)
  1. 파티션 리더가 프로듀서로부터 레코드를 받아서 팔로워들에게 성공적으로 복제함
  2. 프로듀서에게 응답을 보내기 전, 파티션 리더가 있는 브로커에 크래시가 발생함
  3. 프로듀서 입장에서는 응답을 받지 못한 채 타임아웃 발생하고, 메시지를 재전송함
  4. 재전송된 메시지가 새 리더에 도착하지만, 이미 저장되어 있어 중복이 발생함
- 멱등적 프로듀서 기능은 자동으로 이런 중복을 감지하고 처리함

## 멱등적 프로듀서의 작동 원리
- 멱등적 프로듀서 기능
  - 모든 메시지는 고유한 프로듀서 ID와 시퀀스 넘버를 가짐
  - 대상 토픽 및 파티션과 이 두개의 값을 합치면 각 메시지의 고유한 식별자가 됨
  - 각 브로커는 해당 브로커에 할당된 모든 파티션들에 쓰여진 마지막 5개 메시지들을 추적하기 위해 이 고유 식별자를 사용함
  - 파티션별로 추적되어야 하는 시퀀스 넘버의 수를 제한할 수 도 있음
- 브로커가 예전에 받은 메시지를 받으면, 에러를 통해 거부함
- 이 에러는 프로듀서에 로깅 되고 지표값에 반영되지만, 예외가 발생한 것은 아니기에 사용자에게 경보를 보내지 않음

1. 프로듀서 재시작
  - 프로듀서에 장애가 발생하면, 새 프로듀서를 생성해 장애난 것을 대체함
  - 재시작때 멱등적 프로듀서 기능이 켜져있으면, 프로듀서는 초기화 과정에서 카프카 브로커로부터 프로듀서 ID를 생성 받음
  - 트랜잭션 기능이 켜지지 않을 경우, 프로듀서를 초기화할 때마다 완전히 새로운 ID가 생성됨
    - 새 프로듀서가 기존 프로듀서가 전송한 메시지를 다시 보낼 경우 중복을 알아차리지 못함
2. 브로커 장애
  - 브로커 장애가 발생할 경우, 컨트롤러는 장애가 난 브로커가 리더를 맡고 있었던 파티션들에 대해 새 리더를 선출함
  - 리더는 새 메시지가 쓰여질 때마다 인-메모리 프로듀서 상태에 저장된 최근 5개의 시퀀스 넘버를 업데이트함
  - 팔로워 레플리카는 리더로부터 새로운 메시지를 복제할 때마다 자체적인 인-메모리 버퍼를 업데이트함
  - 팔로워가 리더가 된 시점에는 이미 메모리 안에 최근 5개의의 시퀀스 넘버를 가지고 있는 것임
    - 아무 이슈나 지연 없이 새로 쓰여진 메시지의 유효성 검증이 재개될 수 있는 것임
  - 예전 리더가 돌아오면(재시작 되면) 인-메모리 프로듀서 상태는 더 이상 메모리에 저장되어 있지 않음
  - 브로커는 종료되거나 새 세그먼트가 생성될 때마다 프로듀서 상태에 대한 스냅샷을 파일 형태로 저장함
    - 브로커가 시작되면 파일에서 최신 상태를 읽어옴
    - 리더로부터 복제한 레코드를 사용해 프로듀서 상태를 업데이트해 최신 상태로 만듬
## 멱등적 프로듀서의 한계
- 카프카의 멱등적 프로듀서는 프로듀서의 내부 로직으로 인한 재시도가 발생한 경우 생기는 중복만 방지함
  - ex) 여러 개의 인스턴스를 띄우거나 하나의 인스턴스에서 여러 개의 프로듀서를 띄워서 프로듀서들이 두 개의 동일한 메시지를 보내면 중복 못잡음
    - 파일 디렉토리와 같은 원본에서 데이터를 읽어서 카프카로 쓰는 애플리케이션에서 꽤 흔함
## 멱등적 프로듀서 사용법
- 프로듀서 설정에 enable.idempotence=true를 추가해주면 됨
- 멱등적 프로듀서를 활성화시키면
  - 브로커드은 모든 프로듀서 인스턴스에 들어온 레코드 배치의 시퀀스 넘버를 검증해서 메시지 중복을 방지함
  - 장애가 발생하더라도 각 파티션에 쓰여지는 메시지들의 순서를 보장함
## 트랜잭션
- 트랜잭션 기능은 스트림 처리 애플리케이션을 위해 특별히 개발되었음
  - 스트림 처리 애플리케이션의 기본 패턴인 읽기 - 처리 - 쓰기에 사용하도록 개발됨
  - 트랜잭션 기능은 '정확히 한 번' 의미 구조를 보장함
  - 금융 애플리케이션에서 '정확히 한번' 기능이 대표적임 
### 트랜잭션이 해결하는 문제
- 애플리케이션 크래시로 인한 재처리
- 좀비 애플리케이션에 의해 발생하는 재처리
### 트랜잭션이 해결할 수 없는 문제
- '정확히 한 번' 보장에 도움이 되지 않는 몇 가지 경우
  1. 스트림 처리에 있어서의 부수 효과
  2. 카프카 토픽에서 읽어서 데이터베이스에 쓰는 경우
  3. 데이터베이스에서 읽어서, 카프카에 쓰고 여기서 다시 DB에 쓰는 경우
  4. 한 클러스터에서 다른 클러스터로 데이터 복제
  5. 발행/구독 패턴
### 트랜잭션 사용법
p.218 ~p.224
### 트랜잭션 성능
- 트랜잭션은 프로듀서에 약간의 오버헤드를 발생시킴
- 프로듀서에 있어서 트랜잭션 오버헤드는 트랜잭션에 포함된 메시지의 수와는 무관함
- 트랜잭션마다 많은 수의 메시지를 집어넣는 쪽이 상대적으로 오버헤드가 적을뿐 아니라 동기적으로 실행되는 단계의 수도 줄어듬
- 결과적으로 전체 처리량은 올라감
- 컨슈머는 아직 완료되지 않은 트랜잭션에 속하는 메시지들은 버퍼링할 필요가 없음

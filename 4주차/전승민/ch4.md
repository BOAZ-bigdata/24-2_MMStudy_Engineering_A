# 카프카 컨슈머 : 카프카에서 데이터 읽기
- 카프카에서 데이터를 읽는 애플리케이션은 토픽을 구독하고, 구독한 토픽들로부터 메시지 받기 위해 KafkaConsumer를 사용함

## 카프카 컨슈머: 개념

### 컨슈머와 컨슈머 그룹
- 토픽으로부터 데이터를 읽어 오는 작업을 확장할 수 있어야 함
- 여러 개의 컨슈머가 같은 토픽으로부터 데이터를 분할해서 읽어올 수 있어야 함
- 동일한 컨슈머 그룹에 속한 여러 컨슈머는 동일한 토픽을 구독하였지만, 서로 다른 파티션의 메시지를 받음
<img width="759" alt="스크린샷 2024-08-07 오전 2 33 02" src="https://github.com/user-attachments/assets/e3c0e193-9985-4ef7-8c05-58c2b02fab59">

- 컨슈머 그룹에 컨슈머를 추가하는 것은 카프카 톡픽에서 읽어오는 데이터 양을 확장하는 주된 방법임
- 그러나 토픽에 설정된 파티션 수 이상으로 컨슈머를 추가하는 것은 아무 의미 없음
- 카프카는 성능 저하 없이 확장이 가능함
<img width="864" alt="스크린샷 2024-08-07 오전 2 37 05" src="https://github.com/user-attachments/assets/52058e71-fef3-4831-bde8-e5660aedc14c">

- 추가된 컨슈머 그룹은 기존 컨슈머 그룹의 영향을 받지 않고, 독립적으로 수행됨

### 컨슈머 그룹과 파티션 리밸런스
- 컨슈머 그룹에 컨슈머가 추가되거나, 삭제되면 재할당을 통해 밸런스를 맞춤
- 조급한 리밸런스
  - 모든 컨슈머가 자신에게 할당된 파티션을 포기하고,
  - 파티션을 포기한 컨슈머 모두가 다시 그룹에 참여해야, 새로운 파티션을 받고 읽기 작업을 할 수 있음
<img width="973" alt="스크린샷 2024-08-07 오전 2 44 36" src="https://github.com/user-attachments/assets/f267a43d-6a58-4d67-8596-e804662b4f97">

- 조급한 리밸런스는 모든 파티션 할당을 해제한 뒤 읽기 작업을 정지시키고, 파티션을 다시 할당함

- 협력적 리밸런스
  - 한 컨슈머에게 할당된 파티션만을 다른 컨슈머에게 재할당 하는거
  - 2개 이상의 단계를 거침
    1. 리더가 재할당할것이라 통보 -> 컨슈머들은 작업 멈추고, 파티션에 대한 소유권 포기
    2. 소유권 포기한 파티션에 리더가 파티션을 재할당함
    3. 안정될때까지 재반복함...
    4. 조급한 리밸런스에서 발생하는 전체 작업이 중단되는 사태는 발생하지 않음..
<img width="973" alt="스크린샷 2024-08-07 오전 2 44 36" src="https://github.com/user-attachments/assets/f267a43d-6a58-4d67-8596-e804662b4f97">

  - 컨슈머는 해당 컨슈머 그룹의 그룹 코디네이터 역할을 지정받은 카프카 브로커에 하트비트를 전송함으로써 맴버쉽과 할당된 파티션에 대한 소유권을 유지함
  - 하트비트 -> 주기적으로 파악함
- 정적 그룹 맴버쉽
  - 컨슈머가 갖는 컨슈머 그룹의 맴버 자격은 일시적임
  - 컨슈머 그룹 나가면, 끝남.. 다시 들어오면 재할당 받고...
  - 컨슈머에 고유한 group.instance.id값(정적으로 참여하게 해줌)을 잡아주지 않으면 유효함 -> 리밸런스를 발생시키지 않음
  - 정적 그룹 맴버쉽은 애플리케이션이 각 컨슈머에 할당된 파티션의 내용물을 사용해서 로컬이나 캐시를 유지할때 편리함
  - 반복 작업에 효율적
  - 재할당되지 않기에, 잃어버린 파티션들로부터 메시지를 읽어오지 않음, 나중에 컨슈머가 다시 와서 읽으면 순서는 맨 뒤로 이동할거임...
  - 컨슈머 그룹 정적 맴버가 종료됨은 session.timout.ms 설정에 달려있음
 
  ## 카프카 컨슈머 생성하기

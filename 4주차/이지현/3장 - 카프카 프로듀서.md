# 3장 카프카 프로듀서: 카프카에 메시지 쓰기

카프카를 사용할 때는 카프카에 데이터를 쓸 때 사용하는 프로듀서나 읽어 올 때 사용하는 컨슈머, 혹은 두 가지 기능 모두를 수행하는 애플리케이션을 생성해야함.

카프카에 각각의 트랜잭션을 전송하는 클라이언트 애플리케이션이 있고,

다른 애플리케이션에서는 이 트랜잭션이 발생하는 순간 룰 엔진을 사용해서 트랜잭션의 적합 여부 검사하고, 결정된 응답은 다시 카프카에 쓰여져서 해당 트랜잭션이 시작된 올라인 쇼핑몰로 전달.

그리고 세 번째 애플리케이션이 카프카로부터 트랜잭션과 승인 상태를 읽어와서 나중에 분석가들이 확인하고 개선할 수 있게 저장.

## 프로듀서 개요
서로 다른 요구 조건을 가지고 있기 때문에 카프카에 메시지를 쓰기 위해 프로듀서 API 사용하는 방식과 설정에 영향을 미친다. 

카프카에 메시지를 쓰는 작업은 ProducerRecord 객체를 생성함으로써 시작된다. 레코드가 저장될 토픽과 밸류 지정은 필수, 키와 파티션 지정은 선택

가장 먼저 프로듀서가 하는 일은 키와 값 객체가 네트워크 상에서 전송될 수 있도록 직렬화해서 바이트 배열로 변환하는 과정

파티션을 지정하지 않았다면 파티셔너가 파티션은 결정하고 메시지가 전송될 토픽과 파티션이 확정되면 프로듀서는 레코드 배치에 추가한다. 이 배치를 적절한 카프카 브로커에게 전송한다.

브로커가 메시지를 받으면 응답을 돌려줘야한다. 성공시 레코드의 오프셋을 담은 RecordMetadata 객체를 리턴하고 실패 시 에러 리턴한다,

## 3.2 카프카 프로듀서 생성하기
프로듀서 객체를 생성할 때 꼭 들어가야 하는 3개의 필수 속성값이 있다
1. bootstrap.servers

카프카 클러스터와 첫 연결을 생성하기 위해 프로듀서가 사용할 브로커의 host:port 목록, 최소 2개 이상을 지정할 것을 권장

2. key.serializer

캬프카에 쓸 레코드의 키의 값을 직렬화하기 위해 사용하는 시리얼라이저 클래스의 이름

프로듀서 인터페이스는 임의의 자바 객체를 키 혹은 밸류로 전송할 수 있도록 매개변수화된 타입 사용하기

3. value.serializer

카프카에 쓸 레코드의 밸류값을 직렬화하기 위해 사용하는 시리얼라이저 클래스의 이름. 
밸류값으로 쓰일 객체를 직렬화하는 클래스 이름을 value.serializer에 설정해주면 됨.

## 메시지 전송 법
- 파이어 앤 포겟

메시지를 서버에 전송만 하고 성공 혹은 실패 여부에는 신경 쓰지 않는다.
- 동기적 전송

카프카 프로듀서는 언제나 비동기적으로 작동, 메시지를 보내면 send() 메서드는 Future 객체를 리턴
- 비동기적 전송

콜백 함수와 함께 send() 메서드를 호출하면 카프카 브로커로부터 응답을 받는 시점에서 자동으로 콜백 함수 호출

## 3.3 카프카로 메시지 전달하기.
간단한 순서

1. 프로듀서가 ProducerRecord 객체를 받으므로 이 객체를 생성
2. ProducerRecord 전송하기 위해 프로듀서 객체의 send 메서드 사용
3. 카프카 브로커에서의 예외 발생 처리 해야함

### 동기적으로 메시지 전송하기
카프카 브로커가 쓰기 요청에 에러 응답을 내놓거나 재전송 횟수가 소진되었을 때 발생되는 예외를 받아서 처리할 수 있다.

결과적으로 성능이 크게 낮아지기 때문에 동기적 전송은 실제로 잘 사용되지 않는다.

### 비동기적으로 메시지 전송하기 
메시지를 보내고 굳이 응답을 기다리지 않지만, 메시지 전송에 완전히 실패했을 경우에는 알아야한다.

이 에러를 처리하는 경우를 위해 프로듀서는 레코드를 전송할 때 콜백을 지정할 수 있어야 함

## 시리얼라이저
시리얼라이저란 무엇일까? 직렬화를 돕는 도구

그렇다면 직렬화란?

-> 컴퓨터 프로그램에서 사용하는 객체나 데이터 구조를 바이트 스트림으로 변환하는 과정

정수값을 직렬화하는 경우 말고도 일반적인 레코드를 직렬화하여야 한다. 

### 커스텀 시리얼라이저
카프카로 전송해야하는 객체가 단순한 문자열이나 정슛값이 아닌 경우 선택 가능한 2가지 방법
1. 레코드를 생성하기 위해 에이브로, 스리프트, 프로토버프 와 같은 범용 직려로하 라이버리를 사용한다

    - 이걸 더 권장한다.

2. 사용하고 있는 객체를 직렬화하기 위한 커스텀 직렬화 로직을 작성한다. 


## 파티션
키의 역할은 그 자체로 그 메시지에 함께 저장되는 추가적인 정보이기도 하고, 하나의 토픽에 속한 여러 개의 파티션 중 해당 메시지가 저장될 파티션을 결정짓는 기준점이기도 하다.

각 파티션별로 저장되는 메시지 개수의 균형을 맞추기 위해 라운드 로빈 알고리즘이 사용된다.

하지만 항상 이런 방식으로 파티션 생성되는 것은 아니고, 각 상황에 맞게 해시값을 사용하여 파티셔닝한다.

### 헤더
레코드는 키값, 밸류값 외에도 헤더를 사용할 수 있다. 헤더의 주된 용도 중 하나는 메시지의 전달 내역을 기록하는 것

### 인터셉터
회사 내에서 사용하는 모든 애플리케이션에 동일한 작동을 집어넣거나 원래 코드를 사용할 수 없는 경우 ProducerInterceptor 사용한다.
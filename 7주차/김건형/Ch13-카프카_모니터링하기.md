# 카프카 모니터링하기

## 지표 기초

### 비애플리케이션 지표

> 모든 지표의 출처가 카프카인 것은 아님

- 지푯값
	- 애플리케이션 지표
		- 카프카 자체의 JMX 인터페이스에서 나온 지표
	- 로그
		- 카프카 자체에서 나온 모니터링 데이터
		- 숫자가 아닌 텍스트 or 구조화된 데이터
			- 추가 처리 필요
	- Infrastructure 지표
		- 요청이 들어오는 길목인 카프카의 앞단에 설치되어 있음
		- 제어할 수 있는 시스템에서 발생하는 지표
		- e.g. 로드 밸런서
	- 특수 클라이언트 지표
		- 카프카 외부의 툴에서 나온 데이터
		- e.g. 카프카 모니터와 같은 외부 모니터링 툴
	- 일반 클라이언트 지표
		- 카프카 클러스터에 접속한 카프카 클라이언트로부터 나온 지표

---

## 서비스 수준 목표

> SLO : Service-Level Objective
> 클라이언트와 제공되어야 할 인프라스트럭처 서비스의 수준에 대해 이야기하는 수단

- 서비스 수준 지표 [SLI : Service-Level Indicator]
	- 서비스 신뢰성의 여러 측면 중 하나를 가리키는 지표
	- 클라이언트 경험과 크게 연관 있음
	- 웹 서버에서 2xx, 33xx, 4xx 응답을 받은 요청의 비율 등
- 서비스 수준 한계 [SLT : Service-Level Threshold]
	- SLI에 목표값을 결합한 것
	- 99.9%와 같이 비율로 많이 표현하지만, 꼭 그럴 필요는 없음
		- 측정되는 시간 간격도 포함해야 함 (일 단위가 일반적)
	- 7일간 웹 서버에 대한 요청 중 99%가 2xx, 3xx, 4xx 응답을 받아야 한다 등

### SLI 종류

- 지연 [Latency]
	- 응답이 얼마나 빨리 리턴되는가
- 질 [Quality]
	- 응답의 내용이 적절한가
- 보안 [Security]
	- 요청과 응답이 적절히 보호되는가
- 처리량 [Throughput]
	- 클라이언트가 충분한 속도로 데이터를 받을 수 있는가

---

## 카프카 브로커 지표

### 클러스터 문제 진단

크게 3가지 종류가 있음
- 단일 브로커에서 발생하는 문제
- 과적재된 클러스터에서 발생하는 문제
- 컨트롤러 문제

#### 브로커 지표

- 활성 컨트롤러 수 [0 or 1]
	- 1이면 현재 브로커가 컨트롤러
- 컨트롤러 큐 크기
	- 현재 컨트롤러에서 브로커의 처리를 기다리고 있는 요청의 수
	- 계속해서 증가하거나, 높아진 상태로 유지되고 있다면 컨트롤러에 문제가 발생한 것
- 요청 핸들러 유휴 비율
- 전 토픽 바이트 인입
	- 브로커가 프로듀서 클라이언트로부터 얼마나 많은 메시지 트래픽을 받는지에 대한 측정값
- 전 토픽 바이트 유출
	- 트래픽의 전체적인 성장세를 보여주는 지표
	- 컨슈머가 메시지를 읽는 속도를 보여줌
- 전 토픽 메시지 인입
	- 메시지 크기와 무관하게 초당 들어오는 메시지 수를 보여줌
- 파티션 수
- 리더 수
	- 클러스터 안 모든 브로커에 걸쳐 균등해야 함
- 오프라인 파티션
	- 모니터링에 있어 매우 중요한 지표
	- 컨트롤러 역할을 맡고 있는 브로커에서만 제공됨
- 요청 지표


#### JVM 모니터링

- 가비지 수집
- 자바 운영체제 모니터링

#### 운영체제 모니터링

- CPU 사용
- 메모리 사용
- 디스크 사용
- 디스크 I / O
- 네트워크 사용
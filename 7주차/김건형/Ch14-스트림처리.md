# 스트림 처리

- 데이터 스트림
	- 무한히 늘어나는 dataset을 추상화한 것
- 이벤트 스트림
	- 신용카드 결제
	- 주식 거래
	- 택배 배송
	- 네트워크 이벤트
	- 제조 설비 센서 이벤트
	- 이메일
	- 게임

## 이벤트 스트림 특징

- 순서가 있음
- 데이터 레코드는 불변함
- 재생 가능함

- 프로그래밍 패러다임 비교
	- 요청-응답
		- 애플리케이션이 요청을 보낸 뒤 처리 시스템이 응답을 보내 줄 때까지 대기하는 OLTP가 일반적
			- POS, 신용카드 결제, 시간 추적 시스템이 이 패러다임으로 동작
	- 배치 처리
		- 지연이 크지만 처리량도 큼
		- 보통 사전 설정된 시각에 시작됨
		- 데이터 웨어하우스, 인텔리전스 시스템 등이 속함
	- 스트림 처리
		- 연속적이고, 논블로킹하게 작동
		- 응답-요청 방식과 배치 처리 사이의 격차를 메워줌
		- 수 밀리초 이내의 응답을 즉시 요구하지는 않지만, 다음 날까지 기다릴 수는 없는 작업들

## 스트림 처리 개념

- 토폴로지 [topology]
	- 하나 이상의 소스 스트림, 스트림 프로세서의 그래프, 하나 이상의 싱크 스트림이 서로 연결된 것
- 시간
	- 이벤트 시간
		- 다루고자 하는 이벤트가 발생하여 레코드가 생성된 시점
		- 상품이 팔린 시각, 웹 페이지를 조회한 시각 등
	- 로그 추가 시간
		- 접수 시간이라고도 불림
	- 처리 시간
		- 스트림 처리 애플리케이션이 연산을 수행하기 위해 이벤트를 받은 시간
- 상태
	- 로컬 혹은 내부 상태
		- 스트림 처리 애플리케이션의 특정 인스턴스에서만 사용할 수 있는 상태
		- 보통 애플리케이션에 포함되어 구동되는 내장형 인메모리 데이터베이스를 사용하여 유지관리
			- 속도 매우 빠름
			- 사용 가능한 메모리 크기의 제한 받음
	- 외부 상태
		- 카산드라와 같은 NoSQL 시스템을 사용하여 저장
		- 크기에 제한 없음
		- 지연, 복잡도 증가, 가용성 문제
		- 로컬 캐싱을 통해 지연 부담 최소화 가능
- 스트림-테이블 이원성
	- 테이블과는 달리 스트림은 변경 내역을 저장
	- 스트림 : 변경을 유발하는 이벤트의 연속
	- 테이블을 스트림으로 변환하기 위해서는 테이블을 수정한 변경 내역을 잡아내야 함
	- 스트림을 테이블로 변환하기 위해서는 모든 변경 사항을 테이블에 적용해야 함
		- 스트림을 구체화한다고도 표현함
- 시간 윈도우
	- 대부분의 스트림 작업은 시간을 윈도우라 불리는 구간 단위로 잘라서 처리
	- 이동 평균 계산, 가장 많이 팔린 상품 계산, 99분위 부하 찾아내는 작업 등
- 처리 보장
	- 스트림 처리 애플리케이션의 핵심적인 요구 조건 중 하나는, 장애가 발생했을 경우에도 각각의 레코드를 한 번만 처리할 수 있는 능력

---

## 스트림 처리 디자인 패턴

### 단일 이벤트 처리

- 스트림의 이벤트를 읽어와서 각각의 이벤트를 수정한 뒤, 수정된 이벤트를 다른 스트림에 씀

### 로컬 상태와 스트림 처리

- 대부분의 스트림 처리 애플리케이션은 윈도우 집계와 같이 정보의 집계에 초점을 맞춤
- 스트림의 상태를 유지할 필요가 있음
- 고려사항
	- 메모리 사용
	- 영속성
	- 리밸런싱

### 다단계 처리 / 리파티셔닝

- 매일 상위 10개 주식을 계산해야 하는 경우
	- 각 주식별로 하루 동안의 상승/하락을 산출
	- 하나의 파티션만 가진 새로운 토픽에 결과를 씀
	- 해당 파티션을 하나의 애플리케이션 인스턴스에서 읽어서 매일 상위 10개 주식을 찾음

### 외부 검색을 사용하는 처리: 스트림-테이블 조인

- 스트림 처리를 할 때에는 외부 데이터를 스트림과 조인해야 하는 경우도 있음
- 데이터 확장을 위해 외부 검색을 수행하는 예시
	- 클릭 이벤트가 발생해서 스트림으로 들어올 때마다 프로필 데이터베이스에서 사용자를 찾아 원래의 클릭 이벤트에 사용자 나이와 성별을 추가한 새로운 이벤트를 다른 토픽에 씀

### 테이블-테이블 조인

- 윈도우 처리되지 않는 연산
- 작업이 실행되는 시점에서 양 테이블의 현재 상태를 조인

### 스트리밍 조인

- 한쪽 스트림에 포함된 이벤트를 같은 키값과 함께 같은 시간 윈도우에 발생한 다른 쪽 스트림 이벤트와 맞춰야 함
	- 윈도우 조인이라고도 부름

### 비순차 이벤트

- 잘못된 시간에 스트림에 도착한 이벤트를 처리
- 고려사항
	- 이벤트가 순서를 벗어났음을 알아차릴 수 있어야함
	- 비순차 이벤트의 순서를 복구할 수 있는 시간 영역 정의
	- 순서 복구를 위해 이벤트를 묶을 수 있어야 함
	- 결과를 변경할 수 있어야 함
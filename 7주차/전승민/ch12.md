# 카프카 운영하기
## 토픽 작업
- kafka-topics.sh 툴로 토픽 작업을 쉽게 할 수 있음
  - 클러스터 내 토픽 생성, 변경, 삭제, 정보 조회 가능
- --create : 토픽 생성
- --replication-factor : 클러스터 안에 유지되어야 할 레플리카의 개수
- partitions : 토픽에서 생성할 파티션의 개수
- --list : 토픽 목록 조회하기
명령어 책 읽어보기...

### 파티션 추가하기
- 파티션을 증가시키는 일반적인 이유는 단일 파티션에 쏟아지는 처리량을 줄임으로써 토픽을 더 많은 브로커에 대해 수평적으로 확장시키기 위해서임

### 파티션 개수 줄이기
- 토픽의 파티션 개수는 줄일 수 없음
- 토픽에서 파티션을 삭제한다는 것은 토픽에 저장된 데이터의 일부를 삭제한다는 의미
- 클라이언트 입장에서 일관적이지 않아 보일 수 있음
- 데이터를 남은 파티션에 다시 분배해야하며, 메시지의 순서를 바꾸게 됨
- 파티션을 삭제해야한다면, 토픽을 삭제하고 다시 만들거나, 새로운 버전의 토픽을 생성해 모든 쓰기 트래픽을 새 토픽으로 몰아주는게 좋음
### 토픽 삭제하기
- 자원을 해제하기 위해 삭제할 수 있음
- delete.topic.enable을 true로 설정되어 있어야 함
- 토픽 삭제는 비동기 작업임
- 컨틀롤러가 삭제 작업을 처리하는 방식의 한계 때문에 토픽 지울 때 2개 이상의 토픽을 동시에 삭제하지 말고, 작업 사이에 충분한 시간을 권장함

## 컨슈머 그룹
- 서로 협업해서 토픽에 속한 파티션에서 데이터를 읽어오는 집단을 말함
- kafka-consumer-groups.sh툴을 사용해 컨슈머 그룹을 관리
### 오프셋 관리
- 컨슈머 그룹에 대한 오프셋들을 조회, 삭제하거나 저장된 오프셋을 가져오거나 새로운 오프셋을 저장하는 것도 가능함

## 동적 설정 변경
- kafka-configs.sh를 주로 사용
- 토픽,클라이언트,브로커 등 많은 설정이 클러스터를 끄거나 재설치할 필요 없이 돌아가는 동안, 동적으로 바꿀 수 있는 설정임
  - 토픽 설정 기본값 재정의
  - 클라이언트와 사용자 설정 기본값 재정의
  - 브로커 설정 기본값 재정의
  - 재정의된 설정 상세 조회,삭제
## 쓰기 작업과 읽기 작업
### 콘솔 프로듀셔
- kafka-console-producer.sh를 사용해 카프카 토픽에 메시지를 넣을 수 있음
### 콘솔 컨슈머
- kafka-console-consumer.sh를 사용해 카프카 클러스터 안의 1개 이상의 토픽에 대해 메시지를 읽어올 수 있음
  - 컨슈머 설정 옵션
  - 메시지 포매터 옵션
  - 오프셋 토픽 읽기
## 파티션 관리
- 카프카는 파티션 관리에 사용할 수 있는 스크립트를 가지고 있음
- 하나는 리더 레플리카를 다시 선출하기 위한 툴, 다른 하나는 파티션을 브로커에 할당해주는 저수준 유틸리티
- 두 가지 툴은 카프카 클러스터 안의 브로커 간 메시지 트랙픽의 균형을 직접 맞춰 줘야 할 때 요긴하게 사용함
### 선호 레플리카 선출
- 전체 카프카 클러스터에 대해 부하를 고르게 분배할려면 리더 레플리카를 전체 브로커에 걸쳐 균형 있게 분산해줄 필요가 있음
- 리더 레플리카는 레플리카 목록에 첫 번째 인-싱크 레플리카로 정의됨
  - 자동 리밸런싱 기능이 꺼져있으면, 리더 역할을 인계 받을때 균형이 깨짐
  - 이것을 방지하기 위해 리밸런싱 기능을 키거나, 크루즈 컨틀롤 같은 다른 툴을 사용해 균형을 맞추도록 해야함
- 카프카 클러스터간에 균형이 맞지 않으면, 선호 레플리카 선출을 실행시킬 수 있음
- 컨틀로러에게 파티션에 가장 적합한 리더를 고르도록 함
### 파티션 레플리카 변경하기
- 파티션의 레플리카 할당을 수동으로 변경해줘야 함
  - 자동으로 리더 레플리카를 분산시켰지만, 브로커간 부하가 불균등할때
  - 브로커가 내려가서 파티션이 불완전 복제되고 있을 때
  - 새로 추가된 브로커에 파티션을 빠르게 분산시켜주고 싶을 때
  - 토픽의 복제 팩터를 변경해주고 싶을 때
- kafka-reassign=partitions.sh를 사용하면 됨
### 로그 세그먼트 덤프 뜨기
- 토픽 내 특정 메시지가 오염되어 컨슈머가 처리할 수 없는 경우, 메시지 내용물을 열어봐야 함
- kafka-dump-log.sh 툴을 사용하면 됨
  - 파티션의 로그 세그먼트들을 열어볼 때 사용함
### 레플리카 검증
- 파티션 복제 작업은 일반적인 카프카 컨슈머와 비슷하게 작동함
- 가장 오래된 오프셋부터 복제를 디스크에 시작해 현재 오프셋을 저장해 넣음
- 클러스터 전체에 걸쳐 토픽 파티션의 레플리카들이 서로 동일한 것을 확인할려면
- kafka-replica-verification.sh 툴을 사용하면 됨
  - 주어진 토픽 파티션의 모든 레플리카로부터 메시지를 읽은 뒤, 모든 레플리카가 해당 메시지를 가지고 있는 걸 확인함
  - 이후 주어진 메시지의 최대 랙 값을 출력함
### 기타 툴
- 클라이언트 ACL
- 경량 미러메이커
- 테스트 툴
- ## 안전하지 않은 작업
- 일반적인 클러스터 운영작업 중에 사용하는 것은 권장하지 않음, 비상 상황에서 복구 할때 등..
  - 클러스터 컨트롤러 이전하기
  - 삭제될 토픽 제거하기
  - 수동으로 토픽 삭제하기
 

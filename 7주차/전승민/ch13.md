# 카프카 모니터링
- 카프카 애플리케이션은 작동에 대해 측정값을 제공함
## 지표 기초
### 지표는 어디에 위치한지..
- 카프카의 모든 지표값은 자바 관리 확장 인터페이스를 통해 사용할 수 있음
- 외부 모니터링 시스템 입장에서, 가장 쉬운 방법은 해당 모니터링 시스템에서 제공하는 에이전트를 카프카 프로세스에 붙이는거
- 자바 애플리케이션 모니터링 경험이 없으면, 모니터링 서비스를 고려한느 것도 괜찮음
- 비 애플리케이션 지표
  - 모든 지표의 출처가 카프카인 것은 아님, 출처에 따라 다섯 종류로 나눔
  - 애플리케이션 지표
  - 로그
  - 인프라스트럭처 지표
  - 특수 클라이언트 지표
  - 일반 클라이언트 지표
### 어떤 지표가 필요한지
- 의도가 무엇인지, 데이터를 수집하는데 사용하는 툴은 무엇인지..여러 영향을 받아 결정됨
  1. 경보냐 디버깅이냐
     - 경보를 보내기 위한 지표는 짧은 시간 간격, 문제에 대응하는 시간이 길지 않은 경우에 유용
     - 디버깅은 일정 시간 동안 존재하는 문제의 원인을 자주 진단하거나, 복잡한 문제를 깊게 팔때(시간 범위가 길때..)
  2. 자동화가 목적인지 사람이 볼 것인지
     - 자동화일경우 대량의 메트릭을 사용해서 아주 세세하게 데이터를 수집해도 상관없음
     - 사람이 봐야 할 경우, 경보 피로감에 빠질 수 있기에 지표별로 경보가 나갈 문턱값을 적절히 정의할 필요가 있음
### 애플리케이션 상태 검사
- 상태 검사를 통해 애플리케이션 프로세스가 살아있는지의 여부를 모니터링할 수 있어야 함
  - 브로커가 살아있는지 알려주는 외부 프로세스를 사용한 상태검사
  - 카프카 브로커에서 들어와야 하는 지표가 들어오지 않을 때 경보를 보냄
## 서비스 수준 목표
- 카프카와 같은 인프라스트럭처 서비스 모니터링에서 '서비스 수준 목표'가 중요함
  - 클라이언트와 제공되어야 할 인프라스터럭처 서비스의 수준에 대해 이야기하는 수단임
  - 클라이언트는 내부를 알 필요 없이, 어떠한 인터페이스가 제공되는지, 무엇을 할 수 있는지 알면 됨
### 서비스 수준 정의
- 서비스 수준 지표: 서비스 신뢰성의 여러 측명 중 하나를 가리키는 지표 (목표지향적일수록 더 좋음)
- 서비스 수준 목표는 '서비스 수준 한계'라고도 불림(SLI+목표값)
- 서비스 수준 협약: 서비스 제공자와 클라이언트 사이의 계약
  - 측정 방식, 보고 방식, 지원을 받을 수 있는 방법,SLA를 준수하지 못할때 서비스 제공자가 져야 할 책임 등... 여러개 SLO 포함
  - SLO를 SLA이라고 자주 부름
### 좋은 서비스 수준 지표를 위해서는 어떠한 지표값을 써야 하는가?
- SLI 연관된 지표는 카프카 브로커 외부에서 수집되야함
- SLO는 사용자의 만족 여부를 나타내고, 주관적이기에 측정할 수 없음
- SLI 입장에서 인프라스트럭쳐 지표, 특수 클라이언트 지표, 일반 클라이언트 지표가 좋음
- SLI 종류
  - 지연
  - 질
  - 보안
  - 처리량
- SLI가 SLO의 문턱값 아래 실제 측정값을 근거로 정하는 게 좋음
### 경보에 SLO를 사용하기
- SLO는 주된 경보로 설정되어 있어야 함
  - SLO는 사용자 관점에서 문제를 기술하고, 운영하는 사람 입장에서 가장 먼저 고려해야하기 때문
- SLO는 예전에 경험한 적도 없고 찾아내는 방법도 모르는 문제를 알려주는 역할도 함
- SLO를 경보에 사용하는 가장 좋은 방법은 소진율을 보는 것임
## 카프카 브로커 지표
- 카프카 브로커에는 수많은 지표가 있음
  - 대부분은 카프카의 개발자들이 특정한 이슈나 디버깅을 목적으로 만들었음
  - 대부분은 카프카를 실행하는데 필요한 정보를 제공함
### 클러스터 문제 진단하기
- 카프카 클러스터에 문제가 있을 경우 크게 3가지 종류
  - 단일 브로커에서 발생하는 문제
  - 과적재된 클러스터에서 발생하는 문제
  - 컨트롤러 문제
### 불완전 복제 파티션 다루기
- 카프카 모니터링에 있어서 가장 자주 쓰이는 지표 중 하나는 불완전 복제 파티션임
  - 이 측정값은 클러스터에 속한 브로커 단위로 집계됨
  - 해당 브로커가 리더 레플리카를 잡고 있는 파티션 중 팔로워 레플리카가 따라오지 못하는 파티션의 수를 나타냄
  - 이 지표는 브로커 정지에서부터 자원 고갈에 이르기까지, 카프카 클러스터에서 발생하는 많은 문제에 대한 통찰력을 줌
- 클러스터 수준 문제
  - 부하 불균형
  - 자원 고갈
 - 호스트 수준 문제
   - 하드웨어 장애
   - 네트워킹
   - 다른 프로세스와 충돌
   - 로컬 구성의 차이
### 브로커 지표
- 활성 컨트롤러 수
- 컨트롤러 큐 크기
- 요청 핸들러 유휴 비율
- 전 토픽 바이트 인입(all topics bytes in)
  - 브로커가 프로듀서 클라이언트로부터 얼마나 많은 메시지 트래픽을 받는지에 대한 측정값으로서 유용함
- 전 토픽 바이트 유출
- 전 토픽 메시지 인입
- 파티션 수
- 리더 수
- 오프라인 파티션
- 요청 지표
### 토픽과 파티션별 지표
- 이 지표들은 클라이언트에 연관된 특정한 문제를 디버깅할 때는 꽤 유용함
- 토픽별 지표
- 파티션별 지표 (제한된 상황에서 유용)
### JVM 모니터링
- 가비지 수집
  - JVM의 경우 가장 중요한 모니터링 대상임
- 자바 운영체제 모니터링
### 운영체제 모니터링
- CPU사용, 메모리 사용, 디스크 사용, 디스크 I/O, 네트워크에 집중해야함
### 로깅
- 적합한 로거를 적합한 레벨로 켜는 것이 중요함
- 깔끔하게 하기 위해 로거를 분리하는 것이 좋음

## 클라이언트 모니터링
### 프로듀서 지표
- 카프카 프로듀서 클라이언트는 엄청나게 많은 수의 지표들을 가지고 분류함
-  프로듀서 종합 지표
  - 메시지 배치 크기에서부터 메모리 버퍼 활용에 이르기까지 모든 것을 나타내는 속성을 제공함
- 브로커별, 토픽별 지표
### 컨슈머 지표
- 읽기 매니저 지표
- 브로커별, 토픽별 지표
- 컨슈머 코디네이터 지표
### 쿼터
- 카프카는 하나의 클라이언트가 전체 클러스터를 독차지하는 것을 막기위해 스로틀링을 하는 기능을 가짐
- 허용된 트래픽을 표시함
- 브로커가 판단했을때, 클라리언트가 주어진 쿼터를 초과하면 클라이언트 속도를 감소시킴
## 랙 모니터링
- 카프카 컨슈머에 있어서 가장 중요하게 모니터링해야하는 거..
- 컨슈머 랙은 메시지의 수로 측정됨
  - 프로듀서가 특정 파티션에 마지막으로 쓴 메시지와 컨슈머가 마지막으로 읽고 처리한 메시지 사이의 차임
- 컨슈머 랙 모니터링은 브로커의 파티션 상태와 컨슈머 상태를 둘 다 지켜봄으로써 마지막으로 쓰여진 메시지 오프셋과
- 컨슈머 그룹이 파티션에 대해 마지막으로 커밋한 오프셋을 추적하는 외부 프로세스를 두는 것임
  - 컨슈머 자체와는 상관없이 갱신될 수 있는 객관적인 관점을 제공함
- 복잡성을 줄이기 위해 Burrow를 사용함

## 종단 모니터링
- 클러스터가 제대로 작동하는지 또 다른 외부 모니터링 방식
  - 카프카 클러스터에 메시지를 쓸 수 있는가
  - 클러스터에서 메시지를 읽어 올 수 있는가
- 이 두가지 항목은 정말로 알아야 함..
- 이러한 유형의 모니터링은 카프카 클러스터가 의도한 대로 작동하고 있는지 외부에서 검증할 수 있기에 매우 유용함

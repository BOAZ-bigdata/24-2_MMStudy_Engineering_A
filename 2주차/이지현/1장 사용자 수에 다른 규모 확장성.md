# 1장 사용자 수에 따른 규모 확장성
한 명의 사용자를 지원하는 시스템에서 시작하여 최종적으로 몇 백만 사용자를 지원하는 시스템 설계

## 단일 서버
- 웹 앱, 데이터 베이스, 캐시 등이 전부 서버 한 대에서 실행되는 것을 단일 서버라 한다.
### 사용자 요청 처리 흐름(예시)
1) api.mywebsite.com
: 사용자는 도메인 이름을 이용하여 웹 사이트에 접속 

실제 접속을 위해서는 도메인 이름을 도메인 이름 서비스에 질의 하여 IP 주소로의 변환이 필요

2) 15.125.23.214 : DNS 조회 결과로 IP 주소가 반환

3) 해당 IP 주소로 웹 서버에 HTTP 요청 전달
4) 실제 요청을 받은 웹 서버 HTML 페이지나 JSON 형태의 응답 반환
 
실제 요청은 2가지 종류의 단말로부터 온다
1) 웹 애플리케이션

비즈니스 로직, 데이터 저장 등을 처리하기 위해서는 서버 구현용 언어(자바, 파이썬 등)을 활용하고, 프레젠테이션 용으로는 클라이언트 구현용 언어(HTML,자바스크립트 등)을 사용한다.
2) 모바일 앱

HTTP 프로토콜을 이용한다. 반환도리 응답 데이터의 포맷으로는 보통 JSON이 사용된다.

## 데이터베이스
사용자가 증가하면 여러 서버를 두어야하는데, 하나는 웹/모바일 트래픽 처리(웹 계층) 용도고, 다른 하나는 데이터베이스(데이터 계층) 용이다.

### 데이터베이스 종류
1) 관계형 데이터베이스(RDBMS)

- 자료를 테이블과 열, 칼럼으로 표현한다.
- SQL을 사용하면 여러 테이블에 있는 데이터를 `관계`에 따라 조인하여 합칠 수 있다.
- MySQL, 오라클 데이터베이스, PostgreSQL 등이 있다.
2) 비 관계형 데이터베이스(NoSQL)
- 키-값 저장소(key-value store) / 그래프 저장소 / 칼럼 저장소 / 문서 저장소
- 조인 연산 지원하지 않음
- CouchDB, Neo4j, Cassandra, HBase, Amazon DynamoDB

#### 언제 비-관계형 데이터베이스를 선택하는 것이 좋을까?
- 아주 낮은 응답 지연시간이 요구됨 (= 아주 빠르게 응답해야하는 경우)
- 다루는 데이터가 비정형이라 관계형 데이터가 아님
- 데이터를 직렬화하거나 역질렬화 할 수 있기만 하면 됨
- 아주 많은 양의 데이터를 저장할 필요가 있음

## 수직적 규모 확장 VS 수평적 규모 확장
수직적 규모 확장 : 서버의 성능을 늘리는 것, 더 좋은 CPU 많은 RAM

수평적 규모 확장 : 서버의 수를 늘리는 것.
- 수직적 규모 확장에는 한계가 있기 떄문에 대규모 애플리케이션을 지원하는 데는 이걸 사용
- 앞선 설계는 사용자와 웹 서버가 직접적으로 바로 연결되지만 이렇게 되면 웹 서버 다운 시 사용자는 웹 사이트에 접속할 수 없다.
- 많은 사용자가 접근하여 서버의 한계 상황에 도달하지 않게 `로드밸런서를` 도입한다.

### 로드밸런서
- 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할

사용자는 로드밸런서의 공개 IP 주소로 접속한다. -> 로드밸런서를 사용하면 웹 서버는 클라이언트의 접속을 직접 처리 X

서버 간 통신에는 privateIP 이용한다. 이는 같은 네트워크에 속한 서버 사이의 통신에만 쓰일 수 있는 IP 주소로, 인터넷을 통한 접속 불가

이렇게 만들면 만약 두 대의 서버가 있었을 때 한 대가 고장 나면 모든 트래픽을 다른 서버로 보내면 되니까 전체 다운은 방지된다.

즉, 웹 계층은 해결이 됐다는 것!
-> 그러면 데이터 계층은?

### 데이터베이스 다중화
서버 사이에 주(master)-부(slave) 관계를 설정하고 `데이터 원본은 주 서버에, 사본은 부 서버에 저장`하는 방식.

쓰기 연산을 주 서버에서만 하고, 부 서버에서는 그 사본을 전달 받고 읽기 연산을 지원한다. 

보통 읽기 연산의 비중이 쓰기 연산보다 훨씬 높기 때문에 부 데이터베이스의 수가 주 데이터베이스 수보다 많다.

#### 데이터베이스 다중화 장점
- 더 나은 성능: 데이터 변경 연산은 주 데이터베이스 서버에, 읽기 연산은 부 데이터베이스 서버들로 분산된다
- 안정성: 데이터를 여러 장소에 다중화 시켜놨기에 일부 파괴되어도 데이터는 보존된다.
- 가용성: 데이터를 복제해뒀기 때문에 하나의 데이터베이스 서버에 장애가 발생해도 계속 서비스는 이용할 수 있다.

부 서버가 한 대뿐인데 다운되었다면?
- 읽기 연산은 한시적으로 모두 주 데이터베이스로 전달되고 새로운 부 데이터베이스 서버가 장애 서버를 대체할 것이다.

주 서버가 다운된다면?
- 부 서버도 한 대라면 그게 바로 주 서버가 되고 모든 데이터 베이스 연산은 여기서 수행되고 새로운 부 서버가 추가될 거다.

## 캐시
응답 시간(latency)을 개선하기 위해 캐시를 붙이고 정적 콘텐츠를 콘텐츠 전송 네트워크로 옮기면 개선 가능

- 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리에 두고 사용
- 성능이 개선될 분 아니라 데이터 베이스의 부하를 줄일 수 있다
 
읽기 주도형 캐시 전략 
: 요청을 받은 웹 서버는 캐시에 응답이 저장되어 있는지 보고 캐시에 있으면 바로 클라이언트에 반환해주고 없으면 데이터베이스에서 데이터를 찾아 캐시에 저장하고 클라이언트에 반환

## 콘텐츠 전송 네트워크 (CDN)
정적 콘텐츠를 전송하는데 쓰이는, 지리적으로 분산된 서버의 네트워크

이미지, 비디오, CSS, JavaScript 파일 등을 캐시 가능

### 동작법
어떤 사용자가 웹 사이트를 방문하면, 그 사용자에게 가장 가까운 CDN서버가 정적 콘텐츠를 전달

CDN 서버로부터 멀면 멀수록 웹사이트는 천천히 로드됨.
 
사용자가 이미지 URL을 통해 image.png에 접근해서 CDN 서버의 캐시에 있으면 가져오고 없으면 원본 서버가 파일을 CDN 서버에 반환.

## 무상태 웹 계층
웹 계층을 수평적으로 확장하는 방법을 생각해보아야하는데 그러면 이때 상태 정보를 웹 계층에서 제거해야한다

### 상태정보란?
특정 시점에서의 시스템의 상태. 사용자의 세션 정보, 캐시 데이터, 데이터베이스 트랜잭션 상태 이런 정보를 저장해서 시스템의 성능 및 안정성을 유지시키는 것

### 무상태 아키텍처
상태 정보 의존적인 경우에는 특정 클라이언트가 정해진 서버로만 요청을 전송해야하는데 무상태는 어떤 웹 서버로도 전달될 수 있다.

웹 서버는 상태 정보가 필요할 경우 공유 저장소로부터 데이터를 가져온다. 
즉, 상태 정보가 웹 서버로부터 물리적으로 분리되어 있다.

#### 데이터 센터
가용성을 높이고 전 세계 어디서도 쾌적하게 사용할 수 있게 데이터 센터의 이용은 필수적이다.

데이터 센처 중 하나에 심각한 장애가 발생하면 모든 트래픽은 장애가 없는 데이터 센터로 전송된다, 그러면 각 데이터 센터의 데이터의 동기화가 필수적으로 필요하다.

## 메시지큐
시스템을 더 큰 규모로 확장하기 위해 시스템의 컴포넌트를 분리하여 독립적으로 확장할 수 있어야한다 -> 메시지 큐로 해결

메시지 큐는  메시지 무손실을 보장하는 `비동기 통신`을 지원하는 컴포넌트다.

메시지 큐의 기본 아키텍처는 생산자 또는 발행자라고 불리는 입력 서비스가 메시지를 만들어 메시지 큐에 발행한다. 소비자 혹은 구독자라 불리는 서비스 혹은 서버가 연결되어 있는데 그에 맞는 동작을 수행한다.

장점
- 서버 간의 결합이 느슨해져서 규모 확장성이 보장되어야 하는 안정적 애플리케이션을 구성하기 좋다.
## 로그, 메트릭, 자동화
로그: 에러 로그 모니터링,로그를 단위 서비스로 모아주는 도구를 이용하면 더 좋음
메트릭: 호스트 단위 메트릭은 cpu, 디스크 I/O, 메모리 같은 정보를 얻을 수 있다.
자동화: 빌드,테스트, 배포 등의 절차를 자동화할 수 있고 개발자가 만드는 코드가 검증 절차를 자동으로 거치도록 할 수 있다.
## 데이터베이스의 규모 확장
여기도 수직적 확장과 수평적 확장이 있는데, 수평적 확장을 주로 사용한다
### 수평적 확장 (=샤딩)
대규모 데이터베이스를 샤드라고 부르는 작은 단위로 분할한다.
파티션 키를 이용해서 분할한다. 
#### 생각해봐야 할 문제
- 데이터의 재 샤딩
데이터가 너무 많아져서 하나의 샤드로는 감당하기 어려울 때, 데이터 분포가 균등하지 못할 때
- 유명인사 문제
특정 샤드에 질의가 집중되어 과부하가 걸리는
- 조인과 비정규화
여러 샤드로 분리하고 나면 조인하기가 힘들게 되는
## 백만 사용자, 그리고 그 이상
시스템을 최적화하고 더 작은 단위의 서비스로 분할해야 한다

이 때, 사용하는 기법
- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 정적 콘텐츠는 CDN을 통해 서비스화 할 것
- 각 계층은 독립적으로 분할할 것
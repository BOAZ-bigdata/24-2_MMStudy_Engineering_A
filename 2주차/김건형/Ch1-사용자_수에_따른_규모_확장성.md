# 사용자 수에 따른 규모 확장성

## 단일 서버

- 사용자 단말 ⇄ 웹서버
  - 사용자 --(도메인 이름)--> DNS
    - 도메인 이름 -> IP 주소로 변환됨
  - IP 주소로 HTTP 요청 전달
  - 웹 서버는 HTML 또는 JSON 형태의 응답 반환

## 데이터베이스

- 사용자가 늘면 서버 하나 X. 여러 서버 두어야 함
`ex`
  - 웹 / 모바일 트래픽 처리 용도
  - 데이터베이스 용도

### 관계형 vs 비관계형

- 관계형[SQL]
  - 조인 가능
- 비관계형[NoSQL]
  - Key-Value Store
  - Graph Store
  - Column Store
  - Document Store
<br>
  > **적합한 경우**
  > - 아주 낮은 latency 요구되는 경우
  > - 다루는 데이터가 비정형 데이터인 경우
  > - 데이터의 직렬화 or 역직렬화만 필요한 경우
  > - 저장할 데이터가 아주 많은 경우
  >
---

## 수직적 규모 확장 vs 수평적 규모 확장

- 수직적 규모 확장
  - Scale Up
  - 서버에 고사양 자원을 추가하는 행위
  - 서버로 유입되는 트래픽의 양이 적은 경우 적합
  - 확장에 한계가 있음
  - Failover, Redundancy 방안 제시 X
- 수평적 규모 확장
  - Scale Out
  - 더 많은 서버 추가
  - 대규모 애플리케이션에 적합

### 로드밸런서

부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산

- 사용자는 `로드밸런서`의 공개 IP 주소로 접속
  - 로드밸런서와 웹서버, 웹서버 간의 통신은 사설 IP 주소 이용

### 데이터베이스 다중화

데이터 계층 장애의 자동 복구, 다중화를 지원하기 위한 보편적인 기술

- 쓰기 연산은 마스터에서만 지원
- 부 데이터베이스는 읽기 연산만을 지원
- 병렬로 처리될 수 있는 질의 수 증가 -> 성능 개선
- Reliability, Availability

### 캐시

#### 캐시 계층

- 성능 개선
- 데이터베이스의 부하 줄임
- 독립적인 캐시 계층 규모 확장 가능
<br>

##### 읽기 주도형 캐시 전략 [Read-Through Caching Strategy]

- 웹 서버가 요청을 받으면, 캐시에 응답이 저장되어 있는지 확인
- 저장되어 있다면, 해당 데이터 클라이언트에 반환
- 없다면, 데이터베이스에서 찾아 캐시에 저장한 뒤 클라이언트에 반환

---

## 콘텐츠 전송 네트워크 [CDN]

`정적 콘텐츠`를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크

- 사용자가 웹사이트를 방문하면, 가장 가까운 CDN 서버가 정적 콘텐츠 전달

> **CDN 사용 시 고려해야 할 사항**
>
> - 비용
>   - 자주 사용되지 않는 콘텐츠 캐싱 X. CDN에서 빼자
> - 적절한 만료 시한
>   - 너무 길면 콘텐츠의 신선도 떨어짐
>   - 너무 짧으면 원본 서버에 빈번히 접속
> - 장애 대처 방안
>   - ex. CDN이 응답하지 않을 경우 원본 서버로부터 직접 콘텐츠를 가져오도록 구성
> - 콘텐츠 무효화 방법
>
---

## 무상태 웹 계층

웹 계층의 수평적인 확장을 위해서는 상태 정보를 웹 계층에서 제거해야 함
-> 이렇게 구성된 웹 계층을 `무상태 웹 계층`이라고 함

- 상태 정보 의존적 아키텍처
  - 상태를 유지하여 요청들 사이에 공유되도록 함

  > **고정 세션 [Sticky-Session]**
    > - 같은 클라이언트로부터의 요청은 항상 같은 서버로 전송되어야 함
    > - 로드밸런서는 이를 지원하기 위해 고정 세션 기능 제공
    >   - 로드밸런서에 부담
    >   - 로드밸런서 뒷단에 서버 추가/제거 까다로움
    >   - 서버 장애 처리 복잡
  
- 무상태 서버
  - 위 같은 장치 없음

  > - 사용자로부터의 HTTP 요청이 어떤 웹 서버로도 전달 가능
  > - 상태 정보가 필요할 경우 Shared Storage로부터 데이터 가져옴
  > - 단순함, 안정적, 규모 확장 용이

---

## 데이터 센터

- 지리적 라우팅 [`geoDNS-routing` *OR* `geo-routing`]
  - geoDNS
    - 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 변환할 지 결정할 수 있도록 해주는 DNS 서비스

> **해결해야 할 기술적 난제**
>
> - 트래픽 우회
>   - 올바른 데이터 세넡로 트래픽을 보내는 효과적인 방법
> - 데이터 동기화
>   - 다른 데이터베이스로 우회되어도 데이터를 찾을 수 있어야 함
>     - 데이터를 여러 데이터 센터에 걸쳐 다중화
>
---

## 메시지 큐

- 메시지의 무손실[Durability]을 보장하는, 비동기 통신을 보장하는 컴포넌트
  - 메시지 큐에 보관된 메시지는 소비자가 꺼낼 때까지 안전히 보관됨
- 메시지의 버퍼 역할
- 비동기적 전송

### 기본 아키텍처

> - Producer / Publisher라고 불리는 입력 서비스가 메시지를 만들어 메시지 큐에 Publish
> - Consumer / Subscriber라 불리는 서비스/서버가 메시지를 받아 그에 맞는 동작 수행

- 서비스/서버 간 결합 느슨해짐
  - 규모 확장성이 보장되어야 하는 안정적 애플리케이션 구성
- 소비자 프로세스가 다운되어 있어도 생산자는 메시지 발행 가능
- 생산자 서비스가 가용한 상태가 아니어도 메시지 수신 가능

---

## 데이터베이스의 규모 확장

- 수직적 확장
  - 기존 서버에 더 많은, 또는 고성능의 자원 증설
- 수평적 확장 (=Sharding)
  - `샤드`: 대규모 데이터베이스가 분할된 작은 단위
  - 모든 샤드는 같은 스키마를 쓰며,
    샤드에 보관되는 데이터 사이에는 중복X
  - 샤딩 키 (=파티션 키)
    - 데이터가 어떻게 분산될 지 정하는 하나 이상의 칼럼
  > **샤딩 도입 시 발생할 수 있는 문제**
  > - 데이터의 재 샤딩 [Resharding]
  >   - 데이터가 너무 많아져 샤드를 늘려야 할 때
  >   - 샤드 간 데이터 분포가 균등하지 못할 때 [`Shard Exhaustion`]
  >     - 샤드 키 계산 함수를 변경하고 데이터를 재배치 해야 함
  > - Celebrity 문제 / Hotspot Key 문제
  >   - 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제
  > - 조인, 비정규화
  >   - 여러 샤드에 걸친 데이터는 조인이 힘듦
  >   - 비정규화를 통해 하나의 테이블에서 질의가 수행될 수 있도록 함
